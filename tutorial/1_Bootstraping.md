# Бутстрапинг - создаем скелет бандла
Содрежание
- Окружение проекта, 2 способа разработки
- Создаем хост приложение
- Создаем минимальный бандл

# Окружение
Приступив к созданию бандла возникает вопрос - как разрабатывать?
Ведь бандл не может существовать отдельно от своего приложения-хоста.
Никак, нам потребуется хост.

Здесь есть 2 пути:
1. Если вы разрабатываете бандл с нуля, вы можете создать своё собственное микроприложение Symfony прямо внутри бандла. Мы вернемся к этому варианту в любом случае, так как он понадоиться нам для тестирования.  
     - \+ чистота подхода  
     - \- сложно новичкам, ведь нужно хорошо понимать Symfony
     - \- нужно потратить время на создание микроприложения
     - \- наличие лишнего кода приложения хоста в проекте
1. Если вы занялись рефакторингом существующего проекта и хотите выделить его часть в бандл, то удобнее разрабатывать прямо внутри этого проекта, выделив для этого отдельную папку. Например `./bundles`
     - \+ быстро и просто
     - \+ вы можете сразу же тестировать ваш бандл на вашем реальном проекте
     - \+ все в одном окне IDE, проще рефакторить
     - \- Привязка к приложению хосту, для доработки потребуется иметь доступ к двум репозиториям.
     - \- нужно иметь в виду 2 репозитория в одном проекте (хотя PhpStorm отлично умеет разделять и справляться с этим)
     - \- можно при разработки неочевидно воспользоваться зависимостями приложения хоста, что породит проблемы на другом проекте.

К первому пути мы вернемся в статье о тестировании бандлова, а сейчас пойдем по второму пути.

## Создадим структуру папок
### Для хоста
Сгенерируем Symfony приложение, которое будет служить нам хостом:  
`composer create-project symfony/skeleton host-app`

В корне хоста создадим директорию `bundles`, и сразу добавим её содержимое в `.gitignore`.
В этой папке будут храниться разрабатываемые нами внутри хоста бандлы, и эти файлы не должны попадать в git-репозиторий хоста.
```shell script
mkdir bundles
echo "/bundles" >> .gitignore
```

### Для бандла
Скелет бандла можно аналогчино хосту сгенерировать командой `composer create project`
и удалить лишние файлы. Но чтобы разобраться в устройстве бандла мы создадим все вручную.
Вы увидите насколько это просто.

Внутри `bundles` создадим основную папку нашего будущего бандла `CalendarBundle`,
и внутри неё минимальный набор файлов:
```
src/CalendarBundle.php
composer.json
```

Всего 2 файла!

## Отредактируем `composer.json`
Скопируйте в `composer.json`:
```json
{
    "name": "bravik/calendar-bundle",
    "version": "0.0.1",
    "type": "symfony-bundle",
    "description": "Symfony bundles tutorial example project",
    "license": "proprietary",
    "require": {
        "php": "^7.3"
    },
    "require-dev": {
    },
    "config": {
        "sort-packages": true
    },
    "autoload": {
        "psr-4": {
            "bravik\\CalendarBundle\\": "src/"
        }
    },
    "autoload-dev": {
        "psr-4": {
            "bravik\\CalendarBundle\\Tests\\": "tests/"
        }
    },
    "scripts": {
        "test" : "./vendor/bin/simple-phpunit"
    },
    "extra": {
        "symfony": {
            "allow-contrib": false,
            "require": "5.0.*"
        }
    }
}
```
Разберем содержимое:

```
"name": "bravik/calendar-bundle",
"description": "Health check bundle",
```
Эти обязательные поля устанавливают имя вендора и бандла, а так же описание. При установке с помощью менеджера зависимостей `composer`, код бандла будет помещен в соответствующую папку `vendor/bravik/calendar-bundle`

```
"type": "symfony-bundle"
```
Укажет Symfony, что этот пакет является бандлом. Благодаря `Symfony Flex` при установке в приложение-хост, бандл автоматически будет подключен в `bundles.php`, а так же запустится его рецепт (об этом позже).

```
"version": "0.0.1",
```
Задаст версию бандла. Менеджер зависимостей composer отслеживает и загружает обновления всех установленных в проект пакетов. С помощью семантического версионирования вы можете контроллировать этот процесс. Подробней об этом позже

```
"autoload": {
    "psr-4": {
        "bravik\\CalendarBundle\\": "src"
    }
},
"autoload-dev": {
    "psr-4": {
        "bravik\\CalendarBundle\\Tests\\": "tests"
    }
},
```

Устанавливаем пространство имен для  бандла. Как правило используется формат `<vendorName>\<bundleName>\`. Благодаря этим строкам мы указываем механизму автозагрузки composer, что файлы с пространством имен `bravik\\CalendarBundle` нужно искать в папке `./src` относительно нашего `composer.json`.

Для окружения разработки  дополнительно укажем пространство имет для тестов. Оно понадобиться нам позднее.
   
В секции `require` и `require-dev` определяются зависимости для prod (production) и dev (development) окружения. Все эти зависимости будут установлены автоматически при установке в приложение-хост и будут отслеживаться composer. Кроме php нам пока ничего здесь не требуется.

Остальные опции нам сейчас не интересны.

## Основной PHP - файл бандла
Единственный PHP файл в нашем бандле - `CalendarBundle.php`. Скопируйте туда код:
```php
<?php
namespace bravik\CalendarBundle;

use Symfony\Component\HttpKernel\Bundle\Bundle;

class CalendarBundle extends Bundle
{
}
```
Это основной файл бандла. Он используется для подключения бандла в Symfony проект и настройке его поведения.
  
Имя файла имеет фиксированный формат: `<BundleName>Bundle.php`, -оно определяет имя бандла и заканчивается словом `Bundle`.  
Если не [придерживаться конвенций](https://symfony.com/doc/current/bundles/best_practices.html#bundle-name), то Symfony не сможет автоматически распознать бандл.
  
Внутри файла мы определили корневое пространство имен для нашего бандла.
По конвенции оно выбирается в формате `<VendorName>/<CategoryName>/<BundleName>Bundle`
 
Остальное содержимое бандло может быть пустым.


## Инициализация репозиториев
Вы можете инициализировать репозитории для приложени хоста и бандл отдельно.
```bash
git init
git add .
git commit -m "First"

cd bundles\CalendarBundle
git init
git add .
git commit -m "First"
```
Для удобства я сохраню код обоих проектов в монорепозиторри.

## Подключение бандла в приложение-хост
Бандлы как подключаются с помощью команды `composer require bravik/calendar-bundle`.

Однако если вы выполните её сейчас, `composer` не сможет найти этот пакет: ведь его нет в официальных репозиториях.
Чтобы указать местоположение, где искать наш пакет, нужно отредактировать (добавить) секцию `repositories` в  `composer.json` хоста.  

Во время разработки нам нужно подключить в качестве репозитория локальную папку `bundles/CalendarBundle`:
```json
"repositories": [
    {
        "type" : "path",
        "url" : "./bundles/CalendarBundle"
    }
],
```
При таком подключении в папке `vendor` создасться не скачанная с репозитория копия нашего проекта, а симлинк `/bravik/calendar-bundle` указывающий на нашу  локальную папку. Это позволит работать с бандлом как с удаленной зависимостью, но иметь возможность редактировать файлы на локальной папке и сразу же видеть изменения.

Когда наш бандл достигнет релиза, мы будем подключать наш бандл из удаленного git репозитория:
```json
"repositories": [
    {
        "type" : "vcs",
        "url" : "git@bitbucket.org:bravik/uploaderbundle.git"
    }
],
```
[Подробнее о репозиториях composer](https://getcomposer.org/doc/05-repositories.md)

Теперь после выполнения команды `composer require bravik/calendar-bundle` в `composer.json` хоста добавиться наш бандл в качестве зависимости, а бандл подключится в проект.

Чтобы убедиться в этом, откроем `config/bundles.php`:
```php
<?php

return [
    Symfony\Bundle\FrameworkBundle\FrameworkBundle::class => ['all' => true],
    bravik\CalendarBundle\CalendarBundle::class => ['all' => true],
];
```
Мы видим, что наш бандл был подключен в проект с помощью его основного класса!



